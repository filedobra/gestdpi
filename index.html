<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione DPI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #667eea;
            --bg-secondary: #764ba2;
            --bg-container: white;
            --bg-header: #2c3e50;
            --bg-header-secondary: #34495e;
            --bg-nav: #f8f9fa;
            --text-primary: #2c3e50;
            --text-secondary: white;
            --border-color: #bdc3c7;
            --border-focus: #3498db;
            --table-hover: #f8f9fa;
            --table-border: #ecf0f1;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-container: #0f3460;
            --bg-header: #0f3460;
            --bg-header-secondary: #16213e;
            --bg-nav: #1a1a2e;
            --text-primary: #e94560;
            --text-secondary: #f5f5f5;
            --border-color: #533483;
            --border-focus: #e94560;
            --table-hover: #1a1a2e;
            --table-border: #533483;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-container);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-header) 0%, var(--bg-header-secondary) 100%);
            color: var(--text-secondary);
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 40px;
            background: var(--bg-nav);
            transition: all 0.3s ease;
        }

        .nav-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 30px;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            opacity: 0;
            transform: translateY(20px);
        }

        .nav-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(52, 152, 219, 0.4);
        }

        .nav-button.consegna { background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%); }
        .nav-button.lavoratori { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .nav-button.dpi { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .nav-button.cerca { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
        .nav-button.impostazioni { background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); }
        .nav-button.stampa { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }

        .section {
            display: none;
            padding: 40px;
            min-height: 600px;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: var(--text-primary);
            margin-bottom: 30px;
            font-size: 2em;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            transition: all 0.3s ease;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            background: var(--bg-container);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn.success { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); }
        .btn.danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .btn.warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }

        .table-container {
            overflow-x: auto;
            margin-top: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-container);
            transition: all 0.3s ease;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--table-border);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        th {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background: var(--table-hover);
        }

        .signature-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }

        .signature-canvas {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: crosshair;
            background: white;
            touch-action: none;
        }

        .signature-buttons {
            margin-top: 10px;
        }

        .home-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .home-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .success-message {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .error-text {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .signature-preview {
            max-width: 80px;
            max-height: 40px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: var(--bg-container);
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        #pdf-preview-iframe {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 5px;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }

        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        #loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .signature-preview {
            max-width: 100px;
            max-height: 50px;
            border: 1px solid #ddd;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .nav-grid {
                grid-template-columns: 1fr;
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()" title="Cambia tema">üåô</button>
            <h1>üõ°Ô∏è Gestione DPI</h1>
            <p>Sistema di Gestione Dispositivi di Protezione Individuale</p>
        </div>

        <!-- Home Section -->
        <div id="home-section" class="section active">
            <div class="nav-grid">
                <button class="nav-button consegna" onclick="showSection('consegna-section')">
                    üöö Consegna DPI
                </button>
                <button class="nav-button lavoratori" onclick="showSection('lavoratori-section')">
                    üë• Lavoratori
                </button>
                <button class="nav-button dpi" onclick="showSection('dpi-section')">
                    ü¶∫ DPI
                </button>
                <button class="nav-button cerca" onclick="showSection('cerca-section')">
                    üîç Cerca
                </button>
                <button class="nav-button impostazioni" onclick="showSection('impostazioni-section')">
                    ‚öôÔ∏è Impostazioni
                </button>
                <button class="nav-button stampa" onclick="showSection('stampa-section')">
                    üñ®Ô∏è Stampa
                </button>
            </div>
        </div>

        <!-- Consegna Section -->
        <div id="consegna-section" class="section">
            <button class="home-btn" onclick="showSection('home-section')">üè† Home</button>
            <h2>üöö Consegna DPI</h2>
            
            <div id="error-container"></div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="select-lavoratore">üë§ Lavoratore:</label>
                    <select id="select-lavoratore" onchange="loadWorkerDeliveries()">
                        <option value="">Seleziona lavoratore</option>
                    </select>
                    <div id="error-lavoratore" class="error-text"></div>
                </div>
                
                <div class="form-group">
                    <label for="select-dpi">ü¶∫ DPI:</label>
                    <select id="select-dpi">
                        <option value="">Seleziona DPI</option>
                    </select>
                    <div id="error-dpi" class="error-text"></div>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="quantita">üî¢ Quantit√†:</label>
                    <input type="number" id="quantita" min="1" value="1">
                    <div id="error-quantita" class="error-text"></div>
                </div>
                
                <div class="form-group">
                    <label for="data-consegna">üìÖ Data:</label>
                    <input type="date" id="data-consegna">
                    <div id="error-data" class="error-text"></div>
                </div>
                
                <div class="form-group">
                    <label for="motivo">üìù Motivo:</label>
                    <select id="motivo">
                        <option value="primo">Primo Prelievo</option>
                        <option value="danneggiato">Danneggiato</option>
                        <option value="scaduto">Scaduto</option>
                    </select>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="signature-container">
                    <label>‚úçÔ∏è Firma Preposto:</label>
                    <canvas id="firma-preposto" class="signature-canvas" width="300" height="150"></canvas>
                    <div class="signature-buttons">
                        <button class="btn danger" onclick="clearSignature('firma-preposto')">üóëÔ∏è Cancella Firma</button>
                    </div>
                    <div id="error-firma-preposto" class="error-text"></div>
                </div>
                
                <div class="signature-container">
                    <label>‚úçÔ∏è Firma Lavoratore:</label>
                    <canvas id="firma-lavoratore" class="signature-canvas" width="300" height="150"></canvas>
                    <div class="signature-buttons">
                        <button class="btn danger" onclick="clearSignature('firma-lavoratore')">üóëÔ∏è Cancella Firma</button>
                    </div>
                    <div id="error-firma-lavoratore" class="error-text"></div>
                </div>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <button class="btn success" onclick="addToDelivery()">‚ûï Aggiungi alla consegna</button>
                <button class="btn warning" onclick="saveDelivery()">üíæ Salva Consegna</button>
            </div>
            
            <div id="existing-deliveries" style="display: none;">
                <h3>Consegne precedenti per questo lavoratore:</h3>
                <div id="worker-deliveries-table"></div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>DPI</th>
                            <th>Codice SAP</th>
                            <th>Quantit√†</th>
                            <th>Data</th>
                            <th>Motivo</th>
                            <th>Firma Preposto</th>
                            <th>Firma Lavoratore</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="delivery-table-body">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Lavoratori Section -->
        <div id="lavoratori-section" class="section">
            <button class="home-btn" onclick="showSection('home-section')">üè† Home</button>
            <h2>üë• Gestione Lavoratori</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="nome">üë§ Nome:</label>
                    <input type="text" id="nome" placeholder="Nome del lavoratore">
                </div>
                
                <div class="form-group">
                    <label for="cognome">üë§ Cognome:</label>
                    <input type="text" id="cognome" placeholder="Cognome del lavoratore">
                </div>
                
                <div class="form-group">
                    <label for="matricola">üÜî Matricola:</label>
                    <input type="text" id="matricola" placeholder="Matricola del lavoratore">
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="reparto">üè¢ Reparto:</label>
                    <input type="text" id="reparto" placeholder="Reparto (opzionale)">
                </div>
                
                <div class="form-group">
                    <label for="mansione">üíº Mansione:</label>
                    <input type="text" id="mansione" placeholder="Mansione (opzionale)">
                </div>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <button class="btn success" onclick="addWorker()">‚ûï Aggiungi Lavoratore</button>
                <button class="btn warning" onclick="editWorker()">‚úèÔ∏è Modifica Lavoratore</button>
                <button class="btn danger" onclick="deleteWorker()">üóëÔ∏è Cancella Lavoratore</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Cognome</th>
                            <th>Matricola</th>
                            <th>Reparto</th>
                            <th>Mansione</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="workers-table-body">
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>üìÅ Importa Lavoratori da CSV</h3>
                <div class="form-group">
                    <label for="csv-workers">Seleziona file CSV (nome,cognome,matricola,reparto,mansione):</label>
                    <input type="file" id="csv-workers" accept=".csv">
                </div>
                <button class="btn" onclick="importWorkersCSV()">üì• Importa CSV</button>
                <div id="csv-import-status" style="margin-top: 10px;"></div>
            </div>
        </div>

        <!-- DPI Section -->
        <div id="dpi-section" class="section">
            <button class="home-btn" onclick="showSection('home-section')">üè† Home</button>
            <h2>ü¶∫ Gestione DPI</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="nome-dpi">ü¶∫ Nome DPI:</label>
                    <input type="text" id="nome-dpi" placeholder="Nome del DPI">
                </div>
                
                <div class="form-group">
                    <label for="codice-sap">üè∑Ô∏è Codice SAP:</label>
                    <input type="text" id="codice-sap" placeholder="Codice SAP univoco">
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="categoria">üìÇ Categoria:</label>
                    <select id="categoria">
                        <option value="">Seleziona categoria</option>
                        <option value="Testa">Testa</option>
                        <option value="Occhi">Occhi</option>
                        <option value="Udito">Udito</option>
                        <option value="Vie Respiratorie">Vie Respiratorie</option>
                        <option value="Mani">Mani</option>
                        <option value="Corpo">Corpo</option>
                        <option value="Piedi">Piedi</option>
                        <option value="Anticaduta">Anticaduta</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="scadenza">‚è∞ Scadenza (mesi):</label>
                    <input type="number" id="scadenza" placeholder="Durata in mesi (opzionale)">
                </div>
            </div>
            
            <div class="form-group">
                <label for="note-dpi">üìù Note:</label>
                <input type="text" id="note-dpi" placeholder="Note aggiuntive (opzionale)">
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <button class="btn success" onclick="addDPI()">‚ûï Aggiungi DPI</button>
                <button class="btn warning" onclick="editDPI()">‚úèÔ∏è Modifica DPI</button>
                <button class="btn danger" onclick="deleteDPI()">üóëÔ∏è Cancella DPI</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Codice SAP</th>
                            <th>Categoria</th>
                            <th>Scadenza (mesi)</th>
                            <th>Note</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="dpi-table-body">
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>üìÅ Importa DPI da CSV</h3>
                <div class="form-group">
                    <label for="csv-dpi">Seleziona file CSV (nome,codice_sap,categoria,scadenza_mesi,note):</label>
                    <input type="file" id="csv-dpi" accept=".csv">
                </div>
                <button class="btn" onclick="importDPICSV()">üì• Importa CSV</button>
                <div id="csv-dpi-import-status" style="margin-top: 10px;"></div>
            </div>
        </div>

        <!-- Cerca Section -->
        <div id="cerca-section" class="section">
            <button class="home-btn" onclick="showSection('home-section')">üè† Home</button>
            <h2>üîç Cerca</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="search-type">Tipo di ricerca:</label>
                    <select id="search-type" onchange="updateSearchFields()">
                        <option value="lavoratori">Lavoratori</option>
                        <option value="dpi">DPI</option>
                        <option value="consegne">Consegne</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="search-term">Termine di ricerca:</label>
                    <input type="text" id="search-term" placeholder="Inserisci termine di ricerca">
                </div>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <button class="btn" onclick="performSearch()">üîç Cerca</button>
                <button class="btn warning" onclick="clearSearch()">üóëÔ∏è Pulisci</button>
            </div>
            
            <div id="search-results" class="table-container" style="display: none;">
                <h3>Risultati della ricerca:</h3>
                <div id="search-results-content"></div>
            </div>
        </div>

        <!-- Impostazioni Section -->
        <div id="impostazioni-section" class="section">
            <button class="home-btn" onclick="showSection('home-section')">üè† Home</button>
            <h2>‚öôÔ∏è Impostazioni</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="company-name">üè¢ Nome Azienda:</label>
                    <input type="text" id="company-name" placeholder="Nome dell'azienda">
                </div>
                
                <div class="form-group">
                    <label for="company-logo">üñºÔ∏è Logo Azienda:</label>
                    <input type="file" id="company-logo" accept="image/*">
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="use-logo-print"> Usa logo nelle stampe
                    </label>
                </div>
                
                <div class="form-group">
                    <label>üåô Modalit√† Scura:</label>
                    <label>
                        <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()"> Attiva modalit√† scura
                    </label>
                </div>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <button class="btn success" onclick="saveSettings()">üíæ Salva Impostazioni</button>
                <button class="btn warning" onclick="exportData()">üì§ Esporta Dati</button>
                <button class="btn danger" onclick="importData()">üì• Importa Dati</button>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>üóëÔ∏è Gestione Dati</h3>
                <button class="btn danger" onclick="clearAllData()">‚ö†Ô∏è Cancella Tutti i Dati</button>
                <p style="color: #e74c3c; margin-top: 10px;">
                    ‚ö†Ô∏è Attenzione: Questa operazione canceller√† tutti i dati salvati!
                </p>
            </div>
        </div>

        <!-- Stampa Section -->
        <div id="stampa-section" class="section">
            <button class="home-btn" onclick="showSection('home-section')">üè† Home</button>
            <h2>üñ®Ô∏è Stampa</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="select-lavoratore-stampa">üë§ Lavoratore (per consegne):</label>
                    <select id="select-lavoratore-stampa" onchange="updateDeliveryPreview()">
                        <option value="">Seleziona lavoratore</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="select-reparto">üè¢ Reparto (per lavoratori):</label>
                    <select id="select-reparto">
                        <option value="tutti">Tutti i reparti</option>
                    </select>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="data-inizio">üìÖ Data inizio (opzionale):</label>
                    <input type="date" id="data-inizio" onchange="updateDeliveryPreview()">
                </div>
                
                <div class="form-group">
                    <label for="data-fine">üìÖ Data fine (opzionale):</label>
                    <input type="date" id="data-fine" onchange="updateDeliveryPreview()">
                </div>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <button class="btn" onclick="anteprimaPDF('consegne')">üìÑ Anteprima Consegne DPI</button>
                <button class="btn" onclick="anteprimaPDF('lavoratori')">üë• Stampa Elenco Lavoratori</button>
                <button class="btn" onclick="anteprimaPDF('dpi')">ü¶∫ Stampa Elenco DPI</button>
            </div>
            
            <div id="loading" style="display: none;">
                <p>‚è≥ Generazione PDF in corso...</p>
            </div>
            
            <div id="statusMessage" class="status-message"></div>
            
            <div id="delivery-preview">
                <h3>Anteprima consegne:</h3>
                <div id="delivery-preview-content">
                    <p>Seleziona un lavoratore per visualizzare le consegne.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdf-preview-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePdfPreview()">&times;</span>
            <h2>Anteprima PDF</h2>
            <iframe id="pdf-preview-iframe"></iframe>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn success" onclick="confermaStampa()">üíæ Salva PDF</button>
                <button class="btn" onclick="closePdfPreview()">‚ùå Chiudi</button>
            </div>
        </div>
    </div>

    <script>
        // Variabili globali
        let currentPdfDoc = null;
        let currentPdfName = '';
        let currentDelivery = [];
        let selectedWorkerIndex = -1;
        let selectedDPIIndex = -1;
        let hasSignedPreposto = false;
        let hasSignedLavoratore = false;

        // Funzioni per la gestione del tema
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeToggle(savedTheme);
            
            // Aggiorna il checkbox nelle impostazioni
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            if (darkModeToggle) {
                darkModeToggle.checked = savedTheme === 'dark';
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeToggle(newTheme);
            
            // Aggiorna il checkbox nelle impostazioni
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            if (darkModeToggle) {
                darkModeToggle.checked = newTheme === 'dark';
            }
        }

        function toggleDarkMode() {
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const newTheme = darkModeToggle.checked ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeToggle(newTheme);
        }

        function updateThemeToggle(theme) {
            const themeToggle = document.querySelector('.theme-toggle');
            if (themeToggle) {
                themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                themeToggle.title = theme === 'dark' ? 'Modalit√† chiara' : 'Modalit√† scura';
            }
        }

        // Funzioni di utilit√†
        function showSection(sectionId) {
            // Nascondi tutte le sezioni
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Mostra la sezione selezionata
            document.getElementById(sectionId).classList.add('active');
            
            // Inizializza la sezione specifica
            switch(sectionId) {
                case 'lavoratori-section':
                    loadWorkers();
                    break;
                case 'dpi-section':
                    loadDPI();
                    break;
                case 'consegna-section':
                    loadWorkersForDelivery();
                    loadDPIForDelivery();
                    setTodayDate();
                    // Inizializza i canvas delle firme con un piccolo ritardo
                    setTimeout(() => {
                        initSignatureCanvases();
                    }, 100);
                    break;
                case 'stampa-section':
                    loadWorkersForPrint();
                    loadDepartments();
                    break;
                case 'cerca-section':
                    updateSearchFields();
                    break;
                case 'impostazioni-section':
                    loadSettings();
                    break;
            }
        }

        // Funzioni per la gestione delle firme
        function initSignatureCanvases() {
            try {
                console.log('Inizializzando canvas delle firme...');
                const canvasPreposto = document.getElementById('firma-preposto');
                const canvasLavoratore = document.getElementById('firma-lavoratore');
                
                if (!canvasPreposto || !canvasLavoratore) {
                    console.error('Canvas delle firme non trovati');
                    return;
                }
                
                console.log('Canvas trovati, configurando...');
                setupSignature(canvasPreposto, 'Preposto');
                setupSignature(canvasLavoratore, 'Lavoratore');
                
                console.log('Canvas delle firme inizializzati correttamente');
            } catch (error) {
                console.error('Errore inizializzazione firme:', error);
            }
        }

        function setupSignature(canvas, type) {
            if (!canvas) {
                console.error('Canvas non valido per', type);
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Impossibile ottenere il contesto 2D per', type);
                return;
            }
            
            // Pulisci il canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Imposta lo stile del disegno
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            // Funzione per ottenere le coordinate corrette
            function getEventPos(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                if (e.touches && e.touches.length > 0) {
                    return {
                        x: (e.touches[0].clientX - rect.left) * scaleX,
                        y: (e.touches[0].clientY - rect.top) * scaleY
                    };
                } else {
                    return {
                        x: (e.clientX - rect.left) * scaleX,
                        y: (e.clientY - rect.top) * scaleY
                    };
                }
            }
            
            // Event listeners per mouse
            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const pos = getEventPos(e);
                lastX = pos.x;
                lastY = pos.y;
                
                if (type === 'Preposto') {
                    hasSignedPreposto = true;
                } else {
                    hasSignedLavoratore = true;
                }
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                
                const pos = getEventPos(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                
                lastX = pos.x;
                lastY = pos.y;
            });
            
            canvas.addEventListener('mouseup', () => {
                isDrawing = false;
            });
            
            canvas.addEventListener('mouseout', () => {
                isDrawing = false;
            });
            
            // Event listeners per touch
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isDrawing = true;
                const pos = getEventPos(e);
                lastX = pos.x;
                lastY = pos.y;
                
                if (type === 'Preposto') {
                    hasSignedPreposto = true;
                } else {
                    hasSignedLavoratore = true;
                }
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!isDrawing) return;
                
                const pos = getEventPos(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                
                lastX = pos.x;
                lastY = pos.y;
            });
            
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                isDrawing = false;
            });
        }

        function clearSignature(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                if (canvasId === 'firma-preposto') {
                    hasSignedPreposto = false;
                } else {
                    hasSignedLavoratore = false;
                }
            }
        }

        function isCanvasEmpty(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            for (let i = 0; i < imageData.data.length; i += 4) {
                if (imageData.data[i + 3] !== 0) {
                    return false;
                }
            }
            return true;
        }

        // Funzioni per la gestione dei lavoratori
        function loadWorkers() {
            const workers = JSON.parse(localStorage.getItem('lavoratori')) || [];
            const tbody = document.getElementById('workers-table-body');
            tbody.innerHTML = '';
            
            workers.forEach((worker, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${worker.nome}</td>
                    <td>${worker.cognome}</td>
                    <td>${worker.matricola}</td>
                    <td>${worker.reparto || '-'}</td>
                    <td>${worker.mansione || '-'}</td>
                    <td>
                        <button class="btn warning" onclick="selectWorker(${index})">‚úèÔ∏è</button>
                        <button class="btn danger" onclick="removeWorker(${index})">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function addWorker() {
            const nome = document.getElementById('nome').value.trim();
            const cognome = document.getElementById('cognome').value.trim();
            const matricola = document.getElementById('matricola').value.trim();
            const reparto = document.getElementById('reparto').value.trim();
            const mansione = document.getElementById('mansione').value.trim();
            
            if (!nome || !cognome || !matricola) {
                alert('Nome, cognome e matricola sono obbligatori!');
                return;
            }
            
            const workers = JSON.parse(localStorage.getItem('lavoratori')) || [];
            
            // Controlla se la matricola esiste gi√†
            if (workers.some(w => w.matricola === matricola)) {
                alert('Matricola gi√† esistente!');
                return;
            }
            
            const newWorker = { nome, cognome, matricola, reparto, mansione };
            workers.push(newWorker);
            localStorage.setItem('lavoratori', JSON.stringify(workers));
            
            // Pulisci i campi
            document.getElementById('nome').value = '';
            document.getElementById('cognome').value = '';
            document.getElementById('matricola').value = '';
            document.getElementById('reparto').value = '';
            document.getElementById('mansione').value = '';
            
            loadWorkers();
            alert('Lavoratore aggiunto con successo!');
        }

        function selectWorker(index) {
            const workers = JSON.parse(localStorage.getItem('lavoratori')) || [];
            const worker = workers[index];
            
            document.getElementById('nome').value = worker.nome;
            document.getElementById('cognome').value = worker.cognome;
            document.getElementById('matricola').value = worker.matricola;
            document.getElementById('reparto').value = worker.reparto || '';
            document.getElementById('mansione').value = worker.mansione || '';
            
            selectedWorkerIndex = index;
        }

        function editWorker() {
            if (selectedWorkerIndex === -1) {
                alert('Seleziona un lavoratore da modificare!');
                return;
            }
            
            const nome = document.getElementById('nome').value.trim();
            const cognome = document.getElementById('cognome').value.trim();
            const matricola = document.getElementById('matricola').value.trim();
            const reparto = document.getElementById('reparto').value.trim();
            const mansione = document.getElementById('mansione').value.trim();
            
            if (!nome || !cognome || !matricola) {
                alert('Nome, cognome e matricola sono obbligatori!');
                return;
            }
            
            const workers = JSON.parse(localStorage.getItem('lavoratori')) || [];
            
            // Controlla se la matricola esiste gi√† (escludendo il lavoratore corrente)
            if (workers.some((w, i) => w.matricola === matricola && i !== selectedWorkerIndex)) {
                alert('Matricola gi√† esistente!');
                return;
            }
            
            workers[selectedWorkerIndex] = { nome, cognome, matricola, reparto, mansione };
            localStorage.setItem('lavoratori', JSON.stringify(workers));
            
            // Pulisci i campi
            document.getElementById('nome').value = '';
            document.getElementById('cognome').value = '';
            document.getElementById('matricola').value = '';
            document.getElementById('reparto').value = '';
            document.getElementById('mansione').value = '';
            
            selectedWorkerIndex = -1;
            loadWorkers();
            alert('Lavoratore modificato con successo!');
        }

        function deleteWorker() {
            if (selectedWorkerIndex === -1) {
                alert('Seleziona un lavoratore da cancellare!');
                return;
            }
            
            if (confirm('Sei sicuro di voler cancellare questo lavoratore?')) {
                const workers = JSON.parse(localStorage.getItem('lavoratori')) || [];
                workers.splice(selectedWorkerIndex, 1);
                localStorage.setItem('lavoratori', JSON.stringify(workers));
                
                // Pulisci i campi
                document.getElementById('nome').value = '';
                document.getElementById('cognome').value = '';
                document.getElementById('matricola').value = '';
                document.getElementById('reparto').value = '';
                document.getElementById('mansione').value = '';
                
                selectedWorkerIndex = -1;
                loadWorkers();
                alert('Lavoratore cancellato con successo!');
            }
        }

        function removeWorker(index) {
            if (confirm('Sei sicuro di voler cancellare questo lavoratore?')) {
                const workers = JSON.parse(localStorage.getItem('lavoratori')) || [];
                workers.splice(index, 1);
                localStorage.setItem('lavoratori', JSON.stringify(workers));
                loadWorkers();
                alert('Lavoratore cancellato con successo!');
            }
        }

        // Funzioni per l'importazione CSV
        function importWorkersCSV() {
            const fileInput = document.getElementById('csv-workers');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('csv-import-status');
            
            if (!file) {
                alert('Seleziona un file CSV!');
                return;
            }
            
            statusDiv.innerHTML = '<div style="color: #3498db;">üì• Importazione in corso...</div>';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim() !== '');
                    const workers = JSON.parse(localStorage.getItem('lavoratori')) || [];
                    let imported = 0;
                    let skipped = 0;
                    let errors = [];
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const parts = line.split(/[,;]/).map(s => s.trim().replace(/^["']|["']$/g, ''));
                        
                        if (parts.length < 3) {
                            errors.push(`Riga ${i + 1}: non abbastanza campi`);
                            skipped++;
                            continue;
                        }
                        
                        const [nome, cognome, matricola, reparto = '', mansione = ''] = parts;
                        
                        if (!nome || !cognome || !matricola) {
                            errors.push(`Riga ${i + 1}: campi obbligatori mancanti`);
                            skipped++;
                            continue;
                        }
                        
                        if (workers.some(w => w.matricola === matricola)) {
                            errors.push(`Riga ${i + 1}: matricola ${matricola} gi√† esistente`);
                            skipped++;
                            continue;
                        }
                        
                        workers.push({ nome, cognome, matricola, reparto, mansione });
                        imported++;
                    }
                    
                    localStorage.setItem('lavoratori', JSON.stringify(workers));
                    loadWorkers();
                    
                    let resultMessage = `‚úÖ Importazione completata!\nüì• Importati: ${imported}\n‚ö†Ô∏è Saltati: ${skipped}`;
                    
                    if (errors.length > 0 && errors.length <= 5) {
                        resultMessage += '\n\nErrori:\n' + errors.join('\n');
                    } else if (errors.length > 5) {
                        resultMessage += '\n\nPrimi 5 errori:\n' + errors.slice(0, 5).join('\n') + `\n... e altri ${errors.length - 5} errori`;
                    }
                    
                    alert(resultMessage);
                    statusDiv.innerHTML = `<div style="color: #27ae60;">‚úÖ Importazione completata: ${imported} importati, ${skipped} saltati</div>`;
                    fileInput.value = '';
                    
                } catch (error) {
                    console.error('Errore durante l\'importazione del CSV:', error);
                    const errorMessage = 'Errore durante l\'importazione del CSV: ' + error.message;
                    alert(errorMessage);
                    statusDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå ${errorMessage}</div>`;
                }
            };
            
            reader.onerror = function() {
                const errorMessage = 'Errore nella lettura del file';
                alert(errorMessage);
                statusDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå ${errorMessage}</div>`;
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        function importDPICSV() {
            const fileInput = document.getElementById('csv-dpi');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('csv-dpi-import-status');
            
            if (!file) {
                alert('Seleziona un file CSV!');
                return;
            }
            
            statusDiv.innerHTML = '<div style="color: #3498db;">üì• Importazione in corso...</div>';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim() !== '');
                    const dpiList = JSON.parse(localStorage.getItem('dpi')) || [];
                    let imported = 0;
                    let skipped = 0;
                    let errors = [];
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const parts = line.split(/[,;]/).map(s => s.trim().replace(/^["']|["']$/g, ''));
                        
                        if (parts.length < 3) {
                            errors.push(`Riga ${i + 1}: non abbastanza campi`);
                            skipped++;
                            continue;
                        }
                        
                        const [nome, sap, categoria, scadenza = '', note = ''] = parts;
                        
                        if (!nome || !sap || !categoria) {
                            errors.push(`Riga ${i + 1}: campi obbligatori mancanti`);
                            skipped++;
                            continue;
                        }
                        
                        if (dpiList.some(d => d.sap === sap)) {
                            errors.push(`Riga ${i + 1}: codice SAP ${sap} gi√† esistente`);
                            skipped++;
                            continue;
                        }
                        
                        dpiList.push({
                            nome: nome,
                            sap: sap,
                            categoria: categoria,
                            scadenza: scadenza ? parseInt(scadenza) : null,
                            note: note
                        });
                        imported++;
                    }
                    
                    localStorage.setItem('dpi', JSON.stringify(dpiList));
                    loadDPI();
                    
                    let resultMessage = `‚úÖ Importazione completata!\nüì• Importati: ${imported}\n‚ö†Ô∏è Saltati: ${skipped}`;
                    
                    if (errors.length > 0 && errors.length <= 5) {
                        resultMessage += '\n\nErrori:\n' + errors.join('\n');
                    } else if (errors.length > 5) {
                        resultMessage += '\n\nPrimi 5 errori:\n' + errors.slice(0, 5).join('\n') + `\n... e altri ${errors.length - 5} errori`;
                    }
                    
                    alert(resultMessage);
                    statusDiv.innerHTML = `<div style="color: #27ae60;">‚úÖ Importazione completata: ${imported} importati, ${skipped} saltati</div>`;
                    fileInput.value = '';
                    
                } catch (error) {
                    console.error('Errore durante l\'importazione del CSV DPI:', error);
                    const errorMessage = 'Errore durante l\'importazione del CSV DPI: ' + error.message;
                    alert(errorMessage);
                    statusDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå ${errorMessage}</div>`;
                }
            };
            
            reader.onerror = function() {
                const errorMessage = 'Errore nella lettura del file';
                alert(errorMessage);
                statusDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå ${errorMessage}</div>`;
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // Funzioni per la gestione dei DPI
        function loadDPI() {
            const dpiList = JSON.parse(localStorage.getItem('dpi')) || [];
            const tbody = document.getElementById('dpi-table-body');
            tbody.innerHTML = '';
            
            dpiList.forEach((dpi, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${dpi.nome}</td>
                    <td>${dpi.sap}</td>
                    <td>${dpi.categoria}</td>
                    <td>${dpi.scadenza || '-'}</td>
                    <td>${dpi.note || '-'}</td>
                    <td>
                        <button class="btn warning" onclick="selectDPI(${index})">‚úèÔ∏è</button>
                        <button class="btn danger" onclick="removeDPI(${index})">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function addDPI() {
            const nome = document.getElementById('nome-dpi').value.trim();
            const sap = document.getElementById('codice-sap').value.trim();
            const categoria = document.getElementById('categoria').value;
            const scadenza = document.getElementById('scadenza').value;
            const note = document.getElementById('note-dpi').value.trim();
            
            if (!nome || !sap || !categoria) {
                alert('Nome, codice SAP e categoria sono obbligatori!');
                return;
            }
            
            const dpiList = JSON.parse(localStorage.getItem('dpi')) || [];
            
            // Controlla se il codice SAP esiste gi√†
            if (dpiList.some(d => d.sap === sap)) {
                alert('Codice SAP gi√† esistente!');
                return;
            }
            
            const newDPI = { nome, sap, categoria, scadenza: scadenza ? parseInt(scadenza) : null, note };
            dpiList.push(newDPI);
            localStorage.setItem('dpi', JSON.stringify(dpiList));
            
            // Pulisci i campi
            document.getElementById('nome-dpi').value = '';
            document.getElementById('codice-sap').value = '';
            document.getElementById('categoria').value = '';
            document.getElementById('scadenza').value = '';
            document.getElementById('note-dpi').value = '';
            
            loadDPI();
            alert('DPI aggiunto con successo!');
        }

        function selectDPI(index) {
            const dpiList = JSON.parse(localStorage.getItem('dpi')) || [];
            const dpi = dpiList[index];
            
            document.getElementById('nome-dpi').value = dpi.nome;
            document.getElementById('codice-sap').value = dpi.sap;
            document.getElementById('categoria').value = dpi.categoria;
            document.getElementById('scadenza').value = dpi.scadenza || '';
            document.getElementById('note-dpi').value = dpi.note || '';
            
            selectedDPIIndex = index;
        }

        function editDPI() {
            if (selectedDPIIndex === -1) {
                alert('Seleziona un DPI da modificare!');
                return;
            }
            
            const nome = document.getElementById('nome-dpi').value.trim();
            const sap = document.getElementById('codice-sap').value.trim();
            const categoria = document.getElementById('categoria').value;
            const scadenza = document.getElementById('scadenza').value;
            const note = document.getElementById('note-dpi').value.trim();
            
            if (!nome || !sap || !categoria) {
                alert('Nome, codice SAP e categoria sono obbligatori!');
                return;
            }
            
            const dpiList = JSON.parse(localStorage.getItem('dpi')) || [];
            
            // Controlla se il codice SAP esiste gi√† (escludendo il DPI corrente)
            if (dpiList.some((d, i) => d.sap === sap && i !== selectedDPIIndex)) {
                alert('Codice SAP gi√† esistente!');
                return;
            }
            
            dpiList[selectedDPIIndex] = { nome, sap, categoria, scadenza: scadenza ? parseInt(scadenza) : null, note };
            localStorage.setItem('dpi', JSON.stringify(dpiList));
            
            // Pulisci i campi
            document.getElementById('nome-dpi').value = '';
            document.getElementById('codice-sap').value = '';
            document.getElementById('categoria').value = '';
            document.getElementById('scadenza').value = '';
            document.getElementById('note-dpi').value = '';
            
            selectedDPIIndex = -1;
            loadDPI();
            alert('DPI modificato con successo!');
        }

        function deleteDPI() {
            if (selectedDPIIndex === -1) {
                alert('Seleziona un DPI da cancellare!');
                return;
            }
            
            if (confirm('Sei sicuro di voler cancellare questo DPI?')) {
                const dpiList = JSON.parse(localStorage.getItem('dpi')) || [];
                dpiList.splice(selectedDPIIndex, 1);
                localStorage.setItem('dpi', JSON.stringify(dpiList));
                
                // Pulisci i campi
                document.getElementById('nome-dpi').value = '';
                document.getElementById('codice-sap').value = '';
                document.getElementById('categoria').value = '';
                document.getElementById('scadenza').value = '';
                document.getElementById('note-dpi').value = '';
                
                selectedDPIIndex = -1;
                loadDPI();
                alert('DPI cancellato con successo!');
            }
        }

        function removeDPI(index) {
            if (confirm('Sei sicuro di voler cancellare questo DPI?')) {
                const dpiList = JSON.parse(localStorage.getItem('dpi')) || [];
                dpiList.splice(index, 1);
                localStorage.setItem('dpi', JSON.stringify(dpiList));
                loadDPI();
                alert('DPI cancellato con successo!');
            }
        }

        // Funzioni per la gestione delle consegne
        function loadWorkersForDelivery() {
            const workers = JSON.parse(localStorage.getItem('lavoratori')) || [];
            const select = document.getElementById('select-lavoratore');
            select.innerHTML = '<option value="">Seleziona lavoratore</option>';
            
            workers.forEach(worker => {
                const option = document.createElement('option');
                option.value = worker.matricola;
                option.textContent = `${worker.cognome} ${worker.nome} (${worker.matricola})`;
                select.appendChild(option);
            });
        }

        function loadDPIForDelivery() {
            const dpiList = JSON.parse(localStorage.getItem('dpi')) || [];
            const select = document.getElementById('select-dpi');
            select.innerHTML = '<option value="">Seleziona DPI</option>';
            
            dpiList.forEach(dpi => {
                const option = document.createElement('option');
                option.value = dpi.sap;
                option.textContent = `${dpi.nome} (${dpi.sap})`;
                select.appendChild(option);
            });
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('data-consegna').value = today;
        }

        function loadWorkerDeliveries() {
            const workerId = document.getElementById('select-lavoratore').value;
            const existingDeliveriesDiv = document.getElementById('existing-deliveries');
            const tableDiv = document.getElementById('worker-deliveries-table');
            
            if (!workerId) {
                existingDeliveriesDiv.style.display = 'none';
                return;
            }
            
            const deliveries = JSON.parse(localStorage.getItem('consegne')) || [];
            const dpiList = JSON.parse(localStorage.getItem('dpi')) || [];
            const workerDeliveries = deliveries.filter(d => d.lavoratore === workerId);
            
            if (workerDeliveries.length === 0) {
                existingDeliveriesDiv.style.display = 'none';
                return;
            }
            
            let tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>DPI</th>
                            <th>Codice SAP</th>
                            <th>Quantit√†</th>
                            <th>Data</th>
                            <th>Motivo</th>
                            <th>Firma Preposto</th>
                            <th>Firma Lavoratore</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            workerDeliveries.forEach(delivery => {
                const firmaPreposto = delivery.firmaPreposto ? `<img src="${delivery.firmaPreposto}" class="signature-preview" alt="Firma Preposto">` : '-';
                const firmaLavoratore = delivery.firmaLavoratore ? `<img src="${delivery.firmaLavoratore}" class="signature-preview" alt="Firma Lavoratore">` : '-';
                
                // Trova il codice SAP del DPI
                const dpi = dpiList.find(d => d.nome === delivery.dpiText);
                const codiceSAP = dpi ? dpi.sap : 'N/A';
                
                tableHtml += `
                    <tr>
                        <td>${delivery.dpiText}</td>
                        <td><strong>${codiceSAP}</strong></td>
                        <td>${delivery.quantita}</td>
                        <td>${delivery.data}</td>
                        <td>${getReasonText(delivery.motivo)}</td>
                        <td>${firmaPreposto}</td>
                        <td>${firmaLavoratore}</td>
                    </tr>
                `;
            });
            
            tableHtml += '</tbody></table>';
            tableDiv.innerHTML = tableHtml;
            existingDeliveriesDiv.style.display = 'block';
        }

        function getReasonText(reason) {
            switch(reason) {
                case 'primo': return 'Primo Prelievo';
                case 'danneggiato': return 'Danneggiato';
                case 'scaduto': return 'Scaduto';
                default: return reason;
            }
        }

        function addToDelivery() {
            try {
                // Validazione
                let isValid = true;
                const errorMessages = {
                    lavoratore: document.getElementById('error-lavoratore'),
                    dpi: document.getElementById('error-dpi'),
                    quantita: document.getElementById('error-quantita'),
                    data: document.getElementById('error-data'),
                    firmaPreposto: document.getElementById('error-firma-preposto'),
                    firmaLavoratore: document.getElementById('error-firma-lavoratore')
                };

                // Pulisci errori precedenti
                Object.values(errorMessages).forEach(el => el.textContent = '');

                const lavoratore = document.getElementById('select-lavoratore').value;
                const dpi = document.getElementById('select-dpi').value;
                const quantita = parseInt(document.getElementById('quantita').value);
                const data = document.getElementById('data-consegna').value;
                const motivo = document.getElementById('motivo').value;

                if (!lavoratore) {
                    errorMessages.lavoratore.textContent = 'Seleziona un lavoratore';
                    isValid = false;
                }

                if (!dpi) {
                    errorMessages.dpi.textContent = 'Seleziona un DPI';
                    isValid = false;
                }

                if (!quantita || quantita < 1) {
                    errorMessages.quantita.textContent = 'Inserisci una quantit√† valida';
                    isValid = false;
                }

                if (!data) {
                    errorMessages.data.textContent = 'Seleziona una data';
                    isValid = false;
                }

                // Verifica firme
                const canvasPreposto = document.getElementById('firma-preposto');
                const canvasLavoratore = document.getElementById('firma-lavoratore');

                if (!hasSignedPreposto || isCanvasEmpty(canvasPreposto)) {
                    errorMessages.firmaPreposto.textContent = 'Firma del preposto richiesta';
                    isValid = false;
                }

                if (!hasSignedLavoratore || isCanvasEmpty(canvasLavoratore)) {
                    errorMessages.firmaLavoratore.textContent = 'Firma del lavoratore richiesta';
                    isValid = false;
                }

                if (!isValid) {
                    return;
                }

                // Ottieni i nomi per la visualizzazione
                const workers = JSON.parse(localStorage.getItem('lavoratori')) || [];
                const dpiList = JSON.parse(localStorage.getItem('dpi')) || [];
                
                const worker = workers.find(w => w.matricola === lavoratore);
                const dpiItem = dpiList.find(d => d.sap === dpi);
                
                const lavoratoreText = worker ? `${worker.cognome} ${worker.nome}` : lavoratore;
                const dpiText = dpiItem ? dpiItem.nome : dpi;

                // Converti le firme in base64
                const firmaPreposto = canvasPreposto.toDataURL();
                const firmaLavoratore = canvasLavoratore.toDataURL();

                // Aggiungi alla consegna corrente
                const deliveryItem = {
                    lavoratore,
                    lavoratoreText,
                    dpi,
                    dpiText,
                    quantita,
                    data,
                    motivo,
                    firmaPreposto,
                    firmaLavoratore
                };

                currentDelivery.push(deliveryItem);
                renderDeliveryTable();

                // Reset delle firme
                clearSignature('firma-preposto');
                clearSignature('firma-lavoratore');

                alert('Item aggiunto alla consegna!');

            } catch (error) {
                console.error('Errore in addToDelivery:', error);
                alert('Si √® verificato un errore durante l\'aggiunta dell\'item alla consegna.');
            }
        }

        function renderDeliveryTable() {
            const tbody = document.getElementById('delivery-table-body');
            tbody.innerHTML = '';

            currentDelivery.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.dpiText}</td>
                    <td>${item.dpi}</td>
                    <td>${item.quantita}</td>
                    <td>${item.data}</td>
                    <td>${getReasonText(item.motivo)}</td>
                    <td><img src="${item.firmaPreposto}" class="signature-preview" alt="Firma Preposto"></td>
                    <td><img src="${item.firmaLavoratore}" class="signature-preview" alt="Firma Lavoratore"></td>
                    <td>
                        <button class="btn danger" onclick="removeFromDelivery(${index})">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function removeFromDelivery(index) {
            if (confirm('Rimuovere questo item dalla consegna?')) {
                currentDelivery.splice(index, 1);
                renderDeliveryTable();
            }
        }

        function saveDelivery() {
            try {
                if (currentDelivery.length === 0) {
                    alert('Nessun item da salvare nella consegna!');
                    return;
                }

                // Salva la consegna nel localStorage
                let consegneSalvate = JSON.parse(localStorage.getItem('consegne')) || [];
                // Aggiungi i nuovi item di currentDelivery a quelli salvati
                consegneSalvate = consegneSalvate.concat(currentDelivery);
                localStorage.setItem('consegne', JSON.stringify(consegneSalvate));
                
                // Reset currentDelivery e aggiorna la tabella
                currentDelivery = [];
                renderDeliveryTable(); 
                
                alert('Consegna salvata con successo!');
                
                // Aggiorna le consegne precedenti del lavoratore
                loadWorkerDeliveries();

            } catch (error) {
                console.error('Errore in saveDelivery:', error);
                alert('Si √® verificato un errore durante il salvataggio della consegna.');
            }
        }

        // Funzioni per la ricerca
        function updateSearchFields() {
            const searchType = document.getElementById('search-type').value;
            const searchTerm = document.getElementById('search-term');
            
            switch(searchType) {
                case 'lavoratori':
                    searchTerm.placeholder = 'Nome, cognome, matricola o reparto';
                    break;
                case 'dpi':
                    searchTerm.placeholder = 'Nome DPI, codice SAP o categoria';
                    break;
                case 'consegne':
                    searchTerm.placeholder = 'Matricola lavoratore o codice SAP DPI';
                    break;
            }
        }

        function performSearch() {
            const searchType = document.getElementById('search-type').value;
            const searchTerm = document.getElementById('search-term').value.toLowerCase().trim();
            
            if (!searchTerm) {
                alert('Inserisci un termine di ricerca!');
                return;
            }
            
            let results = [];
            
            switch(searchType) {
                case 'lavoratori':
                    const workers = JSON.parse(localStorage.getItem('lavoratori')) || [];
                    results = workers.filter(worker => 
                        worker.nome.toLowerCase().includes(searchTerm) ||
                        worker.cognome.toLowerCase().includes(searchTerm) ||
                        worker.matricola.toLowerCase().includes(searchTerm) ||
                        (worker.reparto && worker.reparto.toLowerCase().includes(searchTerm))
                    );
                    displayWorkersResults(results);
                    break;
                    
                case 'dpi':
                    const dpiList = JSON.parse(localStorage.getItem('dpi')) || [];
                    results = dpiList.filter(dpi => 
                        dpi.nome.toLowerCase().includes(searchTerm) ||
                        dpi.sap.toLowerCase().includes(searchTerm) ||
                        dpi.categoria.toLowerCase().includes(searchTerm)
                    );
                    displayDPIResults(results);
                    break;
                    
                case 'consegne':
                    const deliveries = JSON.parse(localStorage.getItem('consegne')) || [];
                    results = deliveries.filter(delivery => 
                        delivery.lavoratore.toLowerCase().includes(searchTerm) ||
                        delivery.dpi.toLowerCase().includes(searchTerm) ||
                        (delivery.dpiText && delivery.dpiText.toLowerCase().includes(searchTerm))
                    );
                    displayDeliveriesResults(results);
                    break;
            }
            
            document.getElementById('search-results').style.display = 'block';
        }

        function displayWorkersResults(results) {
            const content = document.getElementById('search-results-content');
            
            if (results.length === 0) {
                content.innerHTML = '<p>Nessun lavoratore trovato.</p>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Cognome</th>
                            <th>Matricola</th>
                            <th>Reparto</th>
                            <th>Mansione</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            results.forEach(worker => {
                html += `
                    <tr>
                        <td>${worker.nome}</td>
                        <td>${worker.cognome}</td>
                        <td>${worker.matricola}</td>
                        <td>${worker.reparto || '-'}</td>
                        <td>${worker.mansione || '-'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            content.innerHTML = html;
        }

        function displayDPIResults(results) {
            const content = document.getElementById('search-results-content');
            
            if (results.length === 0) {
                content.innerHTML = '<p>Nessun DPI trovato.</p>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Codice SAP</th>
                            <th>Categoria</th>
                            <th>Scadenza (mesi)</th>
                            <th>Note</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            results.forEach(dpi => {
                html += `
                    <tr>
                        <td>${dpi.nome}</td>
                        <td>${dpi.sap}</td>
                        <td>${dpi.categoria}</td>
                        <td>${dpi.scadenza || '-'}</td>
                        <td>${dpi.note || '-'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            content.innerHTML = html;
        }

        function displayDeliveriesResults(results) {
            const content = document.getElementById('search-results-content');
            
            if (results.length === 0) {
                content.innerHTML = '<p>Nessuna consegna trovata.</p>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Lavoratore</th>
                            <th>DPI</th>
                            <th>Quantit√†</th>
                            <th>Data</th>
                            <th>Motivo</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            results.forEach(delivery => {
                html += `
                    <tr>
                        <td>${delivery.lavoratore}</td>
                        <td>${delivery.dpiText || delivery.dpi}</td>
                        <td>${delivery.quantita}</td>
                        <td>${delivery.data}</td>
                        <td>${getReasonText(delivery.motivo)}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            content.innerHTML = html;
        }

        function clearSearch() {
            document.getElementById('search-term').value = '';
            document.getElementById('search-results').style.display = 'none';
        }

        // Funzioni per le impostazioni
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
            
            if (settings.companyName) {
                document.getElementById('company-name').value = settings.companyName;
            }
            
            if (settings.useLogoOnPrint !== undefined) {
                document.getElementById('use-logo-print').checked = settings.useLogoOnPrint;
            }
            
            // Carica impostazione tema
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            if (darkModeToggle) {
                const currentTheme = localStorage.getItem('theme') || 'light';
                darkModeToggle.checked = currentTheme === 'dark';
            }
        }

        function saveSettings() {
            const companyName = document.getElementById('company-name').value.trim();
            const useLogoOnPrint = document.getElementById('use-logo-print').checked;
            const logoFile = document.getElementById('company-logo').files[0];
            
            const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
            
            if (companyName) {
                settings.companyName = companyName;
            }
            
            settings.useLogoOnPrint = useLogoOnPrint;
            
            if (logoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    settings.logo = e.target.result;
                    localStorage.setItem('appSettings', JSON.stringify(settings));
                    alert('Impostazioni salvate con successo!');
                };
                reader.readAsDataURL(logoFile);
            } else {
                localStorage.setItem('appSettings', JSON.stringify(settings));
                alert('Impostazioni salvate con successo!');
            }
        }

        function exportData() {
            try {
                const data = {
                    lavoratori: JSON.parse(localStorage.getItem('lavoratori')) || [],
                    dpi: JSON.parse(localStorage.getItem('dpi')) || [],
                    consegne: JSON.parse(localStorage.getItem('consegne')) || [],
                    settings: JSON.parse(localStorage.getItem('appSettings')) || {}
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `gestione_dpi_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                alert('Dati esportati con successo!');
            } catch (error) {
                console.error('Errore durante l\'esportazione:', error);
                alert('Errore durante l\'esportazione dei dati.');
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (confirm('Importare i dati? Questo sovrascriver√† tutti i dati esistenti!')) {
                            if (data.lavoratori) localStorage.setItem('lavoratori', JSON.stringify(data.lavoratori));
                            if (data.dpi) localStorage.setItem('dpi', JSON.stringify(data.dpi));
                            if (data.consegne) localStorage.setItem('consegne', JSON.stringify(data.consegne));
                            if (data.settings) localStorage.setItem('appSettings', JSON.stringify(data.settings));
                            
                            alert('Dati importati con successo! Ricarica la pagina per vedere le modifiche.');
                            location.reload();
                        }
                    } catch (error) {
                        console.error('Errore durante l\'importazione:', error);
                        alert('Errore durante l\'importazione: file non valido.');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearAllData() {
            if (confirm('Sei sicuro di voler cancellare TUTTI i dati? Questa operazione non pu√≤ essere annullata!')) {
                if (confirm('ULTIMA CONFERMA: Tutti i lavoratori, DPI e consegne saranno cancellati definitivamente!')) {
                    localStorage.removeItem('lavoratori');
                    localStorage.removeItem('dpi');
                    localStorage.removeItem('consegne');
                    localStorage.removeItem('appSettings');
                    
                    alert('Tutti i dati sono stati cancellati!');
                    location.reload();
                }
            }
        }

        // Funzioni per la stampa - IMPLEMENTAZIONE COMPLETA
        function loadWorkersForPrint() {
            const workers = JSON.parse(localStorage.getItem('lavoratori')) || [];
            const select = document.getElementById('select-lavoratore-stampa');
            select.innerHTML = '<option value="">Seleziona lavoratore</option>';
            
            workers.forEach(worker => {
                const option = document.createElement('option');
                option.value = worker.matricola;
                option.textContent = `${worker.cognome} ${worker.nome} (${worker.matricola})`;
                select.appendChild(option);
            });
        }

        function loadDepartments() {
            const workers = JSON.parse(localStorage.getItem('lavoratori')) || [];
            const departments = [...new Set(workers.map(w => w.reparto).filter(r => r))];
            const select = document.getElementById('select-reparto');
            
            // Mantieni "Tutti i reparti" come prima opzione
            select.innerHTML = '<option value="tutti">Tutti i reparti</option>';
            
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                select.appendChild(option);
            });
        }

        function updateDeliveryPreview() {
            const workerId = document.getElementById('select-lavoratore-stampa').value;
            const dataInizio = document.getElementById('data-inizio').value;
            const dataFine = document.getElementById('data-fine').value;
            const previewContent = document.getElementById('delivery-preview-content');
            
            if (!workerId) {
                previewContent.innerHTML = '<p>Seleziona un lavoratore per visualizzare le consegne.</p>';
                return;
            }
            
            const deliveries = JSON.parse(localStorage.getItem('consegne')) || [];
            const dpiList = JSON.parse(localStorage.getItem('dpi')) || [];
            let filteredDeliveries = deliveries.filter(d => d.lavoratore === workerId);
            
            // Filtra per data se specificata
            if (dataInizio) {
                filteredDeliveries = filteredDeliveries.filter(d => d.data >= dataInizio);
            }
            if (dataFine) {
                filteredDeliveries = filteredDeliveries.filter(d => d.data <= dataFine);
            }
            
            if (filteredDeliveries.length === 0) {
                previewContent.innerHTML = '<p>Nessuna consegna trovata per i criteri selezionati.</p>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>DPI</th>
                            <th>Codice SAP</th>
                            <th>Quantit√†</th>
                            <th>Data</th>
                            <th>Motivo</th>
                            <th>Firma Preposto</th>
                            <th>Firma Lavoratore</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredDeliveries.forEach(delivery => {
                const firmaPreposto = delivery.firmaPreposto ? `<img src="${delivery.firmaPreposto}" class="signature-preview" alt="Firma Preposto">` : '-';
                const firmaLavoratore = delivery.firmaLavoratore ? `<img src="${delivery.firmaLavoratore}" class="signature-preview" alt="Firma Lavoratore">` : '-';
                
                // Trova il codice SAP del DPI
                const dpi = dpiList.find(d => d.nome === (delivery.dpiText || delivery.dpi));
                const codiceSAP = dpi ? dpi.sap : 'N/A';
                
                html += `
                    <tr>
                        <td>${delivery.dpiText || delivery.dpi}</td>
                        <td><strong>${codiceSAP}</strong></td>
                        <td>${delivery.quantita}</td>
                        <td>${delivery.data}</td>
                        <td>${getReasonText(delivery.motivo)}</td>
                        <td>${firmaPreposto}</td>
                        <td>${firmaLavoratore}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            previewContent.innerHTML = html;
        }

        // IMPLEMENTAZIONE COMPLETA DELLA FUNZIONE anteprimaPDF
        function anteprimaPDF(type) {
            try {
                document.getElementById('loading').style.display = 'block';
                
                // Inizializza jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Ottieni le impostazioni dell'azienda
                const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
                const companyName = settings.companyName || 'Azienda';
                
                // Imposta il titolo del documento
                let title = '';
                let filename = '';
                
                switch(type) {
                    case 'consegne':
                        title = 'Registro Consegne DPI';
                        const workerId = document.getElementById('select-lavoratore-stampa').value;
                        const workers = JSON.parse(localStorage.getItem('lavoratori')) || [];
                        const worker = workers.find(w => w.matricola === workerId);
                        filename = worker ? `consegne_${worker.cognome}_${worker.nome}` : 'consegne_dpi';
                        generateDeliveryPDF(doc, title, companyName);
                        break;
                    case 'lavoratori':
                        title = 'Elenco Lavoratori';
                        filename = 'elenco_lavoratori';
                        generateWorkersPDF(doc, title, companyName);
                        break;
                    case 'dpi':
                        title = 'Elenco DPI';
                        filename = 'elenco_dpi';
                        generateDPIPDF(doc, title, companyName);
                        break;
                }
                
                // Salva il PDF
                currentPdfDoc = doc;
                currentPdfName = `${filename}_${new Date().toISOString().split('T')[0]}.pdf`;
                
                // Mostra l'anteprima
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                document.getElementById('pdf-preview-iframe').src = pdfUrl;
                document.getElementById('pdf-preview-modal').style.display = 'block';
                
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Errore nella generazione del PDF:', error);
                alert('Errore nella generazione del PDF: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        function generateDeliveryPDF(doc, title, companyName) {
            const workerId = document.getElementById('select-lavoratore-stampa').value;
            const dataInizio = document.getElementById('data-inizio').value;
            const dataFine = document.getElementById('data-fine').value;
            const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
            
            // Header con logo a sinistra e nome azienda a destra
            if (settings.logo && settings.useLogoOnPrint) {
                // Aggiungi logo a sinistra (posizione 20, 10)
                try {
                    doc.addImage(settings.logo, 'JPEG', 20, 10, 30, 20);
                } catch (error) {
                    console.warn('Errore nel caricamento del logo:', error);
                }
            }
            
            // Nome azienda a destra
            doc.setFontSize(20);
            const pageWidth = doc.internal.pageSize.getWidth();
            const companyNameWidth = doc.getTextWidth(companyName);
            doc.text(companyName, pageWidth - companyNameWidth - 20, 20);
            
            // Titolo centrato
            doc.setFontSize(16);
            const titleWidth = doc.getTextWidth(title);
            doc.text(title, (pageWidth - titleWidth) / 2, 35);
            
            // Data di generazione
            doc.setFontSize(10);
            doc.text(`Generato il: ${new Date().toLocaleDateString('it-IT')}`, 20, 45);
            
            // Filtri applicati
            let y = 55;
            if (workerId) {
                const workers = JSON.parse(localStorage.getItem('lavoratori')) || [];
                const worker = workers.find(w => w.matricola === workerId);
                if (worker) {
                    doc.text(`Lavoratore: ${worker.cognome} ${worker.nome} (${worker.matricola})`, 20, y);
                    y += 7;
                    doc.text(`Reparto: ${worker.reparto || '-'}`, 20, y);
                    y += 7;
                    doc.text(`Mansione: ${worker.mansione || '-'}`, 20, y);
                    y += 10;
                }
            }
            
            if (dataInizio || dataFine) {
                let dateFilter = 'Periodo: ';
                if (dataInizio) dateFilter += `dal ${dataInizio} `;
                if (dataFine) dateFilter += `al ${dataFine}`;
                doc.text(dateFilter, 20, y);
                y += 10;
            }
            
            // Ottieni i dati delle consegne e dei DPI
            const deliveries = JSON.parse(localStorage.getItem('consegne')) || [];
            const dpiList = JSON.parse(localStorage.getItem('dpi')) || [];
            let filteredDeliveries = deliveries;
            
            if (workerId) {
                filteredDeliveries = filteredDeliveries.filter(d => d.lavoratore === workerId);
            }
            if (dataInizio) {
                filteredDeliveries = filteredDeliveries.filter(d => d.data >= dataInizio);
            }
            if (dataFine) {
                filteredDeliveries = filteredDeliveries.filter(d => d.data <= dataFine);
            }
            
            if (filteredDeliveries.length === 0) {
                doc.text('Nessuna consegna trovata per i criteri selezionati.', 20, y + 20);
                return;
            }
            
            // Tabella delle consegne
            y += 20;
            
            // Header della tabella senza colonna Lavoratore
            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            doc.text('DPI', 20, y);
            doc.text('Cod.SAP', 60, y);
            doc.text('Qt√†', 95, y);
            doc.text('Data', 110, y);
            doc.text('Motivo', 135, y);
            doc.text('Firma Preposto', 160, y);
            doc.text('Firma Lavoratore', 185, y);
            
            // Linea sotto l'header
            doc.line(20, y + 2, 200, y + 2);
            
            y += 12;
            doc.setFont(undefined, 'normal');
            
            filteredDeliveries.forEach((delivery, index) => {
                if (y > 240) { // Nuova pagina se necessario
                    doc.addPage();
                    y = 20;
                }
                
                // Trova il codice SAP del DPI
                const dpi = dpiList.find(d => d.nome === (delivery.dpiText || delivery.dpi));
                const codiceSAP = dpi ? dpi.sap : 'N/A';
                
                // Stampa i dati della consegna con pi√π spazio
                doc.text((delivery.dpiText || delivery.dpi).substring(0, 18), 20, y);
                doc.text(codiceSAP.substring(0, 15), 60, y);
                doc.text(delivery.quantita.toString(), 95, y);
                doc.text(delivery.data, 110, y);
                doc.text(getReasonText(delivery.motivo).substring(0, 12), 135, y);
                
                // Aggiungi firme se presenti con dimensioni maggiori
                if (delivery.firmaPreposto) {
                    try {
                        doc.addImage(delivery.firmaPreposto, 'PNG', 160, y - 6, 20, 12);
                    } catch (error) {
                        doc.text('Firmato', 160, y);
                    }
                } else {
                    doc.text('-', 160, y);
                }
                
                if (delivery.firmaLavoratore) {
                    try {
                        doc.addImage(delivery.firmaLavoratore, 'PNG', 185, y - 6, 20, 12);
                    } catch (error) {
                        doc.text('Firmato', 185, y);
                    }
                } else {
                    doc.text('-', 185, y);
                }
                
                y += 18; // Spazio maggiore tra le righe
                
                // Aggiungi una linea separatrice tra le consegne per migliorare la leggibilit√†
                if (index < filteredDeliveries.length - 1) {
                    doc.setDrawColor(200, 200, 200); // Grigio chiaro
                    doc.line(20, y - 9, 200, y - 9);
                    doc.setDrawColor(0, 0, 0); // Ripristina il nero
                }
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Pagina ${i} di ${pageCount}`, 170, 290);
            }
        }

        function generateWorkersPDF(doc, title, companyName) {
            const selectedDept = document.getElementById('select-reparto').value;
            const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
            
            // Header con logo a sinistra e nome azienda a destra
            if (settings.logo && settings.useLogoOnPrint) {
                // Aggiungi logo a sinistra (posizione 20, 10)
                try {
                    doc.addImage(settings.logo, 'JPEG', 20, 10, 30, 20);
                } catch (error) {
                    console.warn('Errore nel caricamento del logo:', error);
                }
            }
            
            // Nome azienda a destra
            doc.setFontSize(20);
            const pageWidth = doc.internal.pageSize.getWidth();
            const companyNameWidth = doc.getTextWidth(companyName);
            doc.text(companyName, pageWidth - companyNameWidth - 20, 20);
            
            // Titolo centrato
            doc.setFontSize(16);
            const titleWidth = doc.getTextWidth(title);
            doc.text(title, (pageWidth - titleWidth) / 2, 35);
            
            // Data di generazione
            doc.setFontSize(10);
            doc.text(`Generato il: ${new Date().toLocaleDateString('it-IT')}`, 20, 45);
            
            let y = 55;
            if (selectedDept && selectedDept !== 'tutti') {
                doc.text(`Reparto: ${selectedDept}`, 20, y);
                y += 10;
            }
            
            // Ottieni i dati dei lavoratori
            const workers = JSON.parse(localStorage.getItem('lavoratori')) || [];
            let filteredWorkers = workers;
            
            if (selectedDept && selectedDept !== 'tutti') {
                filteredWorkers = workers.filter(w => w.reparto === selectedDept);
            }
            
            if (filteredWorkers.length === 0) {
                doc.text('Nessun lavoratore trovato per i criteri selezionati.', 20, y + 20);
                return;
            }
            
            // Tabella dei lavoratori
            y += 20;
            
            // Header della tabella
            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            doc.text('Nome', 20, y);
            doc.text('Cognome', 60, y);
            doc.text('Matricola', 100, y);
            doc.text('Reparto', 130, y);
            doc.text('Mansione', 160, y);
            
            // Linea sotto l'header
            doc.line(20, y + 2, 200, y + 2);
            
            y += 10;
            doc.setFont(undefined, 'normal');
            
            filteredWorkers.forEach((worker, index) => {
                if (y > 270) { // Nuova pagina se necessario
                    doc.addPage();
                    y = 20;
                }
                
                doc.text(worker.nome.substring(0, 15), 20, y);
                doc.text(worker.cognome.substring(0, 15), 60, y);
                doc.text(worker.matricola, 100, y);
                doc.text((worker.reparto || '-').substring(0, 12), 130, y);
                doc.text((worker.mansione || '-').substring(0, 15), 160, y);
                
                y += 8;
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Pagina ${i} di ${pageCount}`, 170, 290);
            }
        }

        function generateDPIPDF(doc, title, companyName) {
            const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
            
            // Header con logo a sinistra e nome azienda a destra
            if (settings.logo && settings.useLogoOnPrint) {
                // Aggiungi logo a sinistra (posizione 20, 10)
                try {
                    doc.addImage(settings.logo, 'JPEG', 20, 10, 30, 20);
                } catch (error) {
                    console.warn('Errore nel caricamento del logo:', error);
                }
            }
            
            // Nome azienda a destra
            doc.setFontSize(20);
            const pageWidth = doc.internal.pageSize.getWidth();
            const companyNameWidth = doc.getTextWidth(companyName);
            doc.text(companyName, pageWidth - companyNameWidth - 20, 20);
            
            // Titolo centrato
            doc.setFontSize(16);
            const titleWidth = doc.getTextWidth(title);
            doc.text(title, (pageWidth - titleWidth) / 2, 35);
            
            // Data di generazione
            doc.setFontSize(10);
            doc.text(`Generato il: ${new Date().toLocaleDateString('it-IT')}`, 20, 45);
            
            // Ottieni i dati dei DPI
            const dpiList = JSON.parse(localStorage.getItem('dpi')) || [];
            
            if (dpiList.length === 0) {
                doc.text('Nessun DPI presente nel sistema.', 20, 65);
                return;
            }
            
            // Tabella dei DPI
            let y = 65;
            
            // Header della tabella
            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            doc.text('Nome DPI', 20, y);
            doc.text('Codice SAP', 80, y);
            doc.text('Categoria', 120, y);
            doc.text('Scadenza', 150, y);
            doc.text('Note', 170, y);
            
            // Linea sotto l'header
            doc.line(20, y + 2, 200, y + 2);
            
            y += 10;
            doc.setFont(undefined, 'normal');
            
            dpiList.forEach((dpi, index) => {
                if (y > 270) { // Nuova pagina se necessario
                    doc.addPage();
                    y = 20;
                }
                
                doc.text(dpi.nome.substring(0, 25), 20, y);
                doc.text(dpi.sap, 80, y);
                doc.text(dpi.categoria.substring(0, 12), 120, y);
                doc.text(dpi.scadenza ? `${dpi.scadenza} mesi` : '-', 150, y);
                doc.text((dpi.note || '-').substring(0, 15), 170, y);
                
                y += 8;
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Pagina ${i} di ${pageCount}`, 170, 290);
            }
        }

        function closePdfPreview() {
            document.getElementById('pdf-preview-modal').style.display = 'none';
        }

        function confermaStampa() {
            if (currentPdfDoc && currentPdfName) {
                currentPdfDoc.save(currentPdfName);
                alert('PDF salvato con successo!');
                closePdfPreview();
            } else {
                alert('Errore: nessun PDF da salvare.');
            }
        }

        // Inizializzazione dell'applicazione
        document.addEventListener('DOMContentLoaded', function() {
            // Inizializza il tema
            initTheme();
            
            // Animazione dei pulsanti di navigazione
            setTimeout(() => {
                const buttons = document.querySelectorAll('.nav-button');
                buttons.forEach((button, index) => {
                    setTimeout(() => {
                        button.style.opacity = '1';
                        button.style.transform = 'translateY(0)';
                    }, index * 100);
                });
            }, 500);
        });
    </script>
</body>
</html>

